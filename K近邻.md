# K近邻法

k近邻法（k-nearest neighbor）是一种基本分类与回归方法。其输入为实例的特征向量，对应于特征空间的点；输出为实例的类别，可以取多类。**k近邻法假设给定一个训练数据集，其中的实例类别已定。分类时，对新的实例，根据其k个最近邻的训练实例的类别，通过多数表决等方式进行预测。**其实质是利用训练集中的数据，对特征向量空间进行划分，并作为其分类的模型。

模型由三个基本要素——距离度量、k值的选择和分类决策规则决定。

### 距离

特征空间中两个实例点的距离是两个实例点相似程度的反映。k近邻模型的特征空间一般是n维实数向量空间 $\mathbb R^n $​​​​。使用的距离是欧氏距离，但也可以是其他距离，例如曼哈顿距离或$L_p$距离。​

### K值

如果选择较小的k值，就相当于用较小的邻域中的训练实例进行预测，“学习”的近似误差（approximation error）会减小，只有与输入实例较近的（相似的）训练实例才会对预测结果起作用。但缺点是“学习”的估计误差（estimation error）会增大，预测结果会对近邻的实例点非常敏感。如果邻近的实例点恰巧是噪声，预测就会出错。也就是说，k值的减小就意味着整体模型变得复杂，容易发生过拟合。

如果选择较大的k值，就相当于用较大邻域中的训练实例进行预测。其优点是可以减少学习的估计误差。但缺点是学习的近似误差会增大。这时与输入实例较远的（不相似的）训练实例也会对预测起作用，使预测发生错误。k值的增大就意味着整体的模型变得简单。

在实际计算中，可以证明，多数表决法即是经验风险最小化。

### 实现：kd树

`kd`树是一种对k维空间中的实例点进行存储以便对其进行快速检索的树形数据结构。`kd`树是二叉树，表示对k维空间的一个划分（partition）。构造`kd`树相当于不断地用垂直于坐标轴的超平面将k维空间切分，构成一系列的k维超矩形区域。`kd`树的每个结点对应于一个k维超矩形区域。

​                                                                           

#### 构造树

其主要方法如下：

输入：K维空间数据集$T=\{x_1,x_2...x_n\}$，其中$x_i=(x^{(1)}_i,x^{(2)}_i...x^{(n)}_i)$

输出：一个`kd`树

1. 开始：构造根结点，根结点对应于包含T的k维空间的超矩形区域。

   选择$x^{(1)}$为坐标轴，以T中所有实例的$x^{(1)}$坐标的中位数为切分点，将根结点对应的超矩形区域切分为两个子区域。切分由通过切分点并与坐标轴$x^{(1)}$垂直的超平面实现。

   由根结点生成深度为1的左、右子结点：左子结点对应坐标$x^{(1)}$小于切分点的子区域，右子结点对应于坐标$x^{(1)}$大于切分点的子区域。

   将落在切分超平面上的实例点保存在根结点。

2. 重复：对深度为j的结点，选择$x^{(l)}$为切分的坐标轴，其中$l＝j(mod \;k)+1$，以该结点的区域中所有实例的$x^{(l)}$坐标的中位数为切分点，将该结点对应的超矩形区域切分为两个子区域。切分由通过切分点并与坐标轴$x^{(l)}$垂直的超平面实现。

   由该结点生成深度为$j+1$的左、右子结点：左子结点对应坐标$x^{(l)}$小于切分点的子区域，右子结点对应坐标$x^{(l)}$大于切分点的子区域。将落在切分超平面上的实例点保存在该结点。

3. 直到两个子区域没有实例存在时停止。从而形成`kd`树的区域划分。



#### 搜索树

给定一个目标点，搜索其最近邻。**首先找到包含目标点的叶结点；然后从该叶结点出发，依次回退到父结点；不断查找与目标点最邻近的结点，当确定不可能存在更近的结点时终止。**这样搜索就被限制在空间的局部区域上，效率大为提高。

输入：已构造的`kd`树；目标点$x$​​；

输出：$x$的最近邻。

1. 在`kd`树中找出包含目标点$x$​的叶结点：从根结点出发，递归地向下访问`kd`树。若目标点x当前维的坐标小于切分点的坐标，则移动到左子结点，否则移动到右子结点。直到子结点为叶结点为止。

2. 以此叶结点为“当前最近点”。

3. 递归地向上回退，在每个结点进行以下操作：

   如果该结点保存的实例点比当前最近点距离目标点更近，则以该实例点为“当前最近点”。

   当前最近点一定存在于该结点一个子结点对应的区域。检查该子结点的父结点的另一子结点对应的区域是否有更近的点。具体地，检查另一子结点对应的区域是否与以目标点为球心、以目标点与“当前最近点”间的距离为半径的超球体相交。

   如果相交，可能在另一个子结点对应的区域内存在距目标点更近的点，移动到另一个子结点。接着，递归地进行最近邻搜索；

   如果不相交，向上回退。

4. 当回退到根结点时，搜索结束。最后的“当前最近点”即为x的最近邻点。

如果实例点是随机分布的，`kd`树搜索的平均计算复杂度是$O(logN)$​，这里N是训练实例数。`kd`树更适用于训练实例数远大于空间维数时的k近邻搜索。当空间维数接近训练实例数时，它的效率会迅速下降，几乎接近线性扫描。

### 总结

k近邻法是基本且简单的分类与回归方法。k近邻法的基本做法是：对给定的训练实例点和输入实例点，首先确定输入实例点的k个最近邻训练实例点，然后利用这k个训练实例点的类的多数来预测输入实例点的类。

基于这一目标，有多种方式进行实现，比如说构造`kd`树后在`kd`树中进行查找搜索查找。

